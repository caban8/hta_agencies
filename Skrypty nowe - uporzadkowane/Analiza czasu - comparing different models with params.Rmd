---
title: "Country comparison in terms of the time to recommendation"
output: 
  html_document:
    code_folding: show
    theme:
      bg: "#202123"
      fg: "#B8BCC2"
      primary: "#EA80FC"
      secondary: "#00DAC6"
      base_font:
        google: Prompt
      heading_font:
        google: Proza Libre
params:
  transformation: "none"
  country_fixed: true
---

# Setup

```{r setup, include=FALSE}
if (requireNamespace("thematic")) 
  thematic::thematic_rmd(font = "auto")

knitr::opts_chunk$set(fig.width = 10, dpi = 300)


pacman::p_load(rstatix, readxl, tidyverse, broom, lme4)

df <- read_excel("d:/SPSS and statistics/Work/Zlecenia/Aneta Mela/Baza filtr na dates 2024-03-04.xlsx") 

df <- df %>% 
  select(-c(...1, ...2))



# Ustalam levels dla countries tak, żeby Poland było kategorią referencyjną
Kraj_lvls <- c(
      "Poland",
      "Australia",
      "Canada",
      "England",
      "France",
      "Germany",
      "Ireland",
      "New Zealand",
      "Norway",
      "Scotland",
      "The Netherlands",
      "Wales"  
    )

# Ustalam poziomy factors - Poland first
df <- df %>% 
  mutate(Kraj = factor(Kraj, levels = Kraj_lvls))



# Lump categories few observations to "other" and add DV transformations 
df <- df %>% 
  mutate(
    Therapeutic_lumped = fct_lump(Obszar_terapeutyczny, n = 7),
    Therapeutic_lumped = fct_relevel(Therapeutic_lumped, "Other"),
    log_days = if_else(dni_do_rekomendacji == 0, 1, dni_do_rekomendacji) %>% log(),
    Drug_category = if_else(Kategoria_lek == "Orphan", "Orphan", "Other")
    ) 




```


** JAK WSZYSTKO ZAUTOMATYZOWAĆ ŻEBY SPRAWDZAĆ WSZYSTKIE WARIANTY MODELI ** 

# Uwagi

Celem logarytmizacji dni do rekomendacji, liczba dni, która wynosiła zero zostala przekształcona do 1 (to dało możliwość obliczenia logarytmu).


# Methodology

-   Ważna kwestia. Teoretycznie mamy tutaj do czynienia z jakąś formą within-design. W końcu agencja to pojedynczy byt, dla którego mamy więcej niż jeden powtórzony pomiar.

**Mixed effects model**

What exactly having different intercepts for the random effect variable means? How can I make a conceptual or theoretical connection here?


**Which variables can be inclued as fixed-effects?**

Is there a theoretical justification to include criteria of benefits, like clinical benefit or cost-effectiveness, in the model?

There is definitely a theoretical basis for including therapeutic area, as the processing of drugs from different areas might be guided by different goals which could be reflected in differences of their prioritization by specific medical and govermnetal insitutions.

Whether the recommendation was positive or negative might also play a role. It should be easier to find reasons to dismiss a drug than to accept it, as rejection is often a result of not meeting just one of many criteria, while acceptance is more often associated with meeting all of them. 


# Infrastruktura



## Tables

```{r}

html_table <- function(x) {
  x %>% 
    knitr::kable()
}

```



## Params - Parameters

Parameters included in order to vary the models:

-   Country as a fixed vs random effects?
    -   Something to consider in theoretical terms
-   Number of additional fixed effects
    -   Therapeutic area
-   Transformation of the dependent variable (to correct deviations from the assumptions, if necessary)
    -   Logarithmic
    -   Other?
    

Should I compare the AIC (or other similar measure) between lm and lmer models? To justify using the latter?

    

Params for iterated markdown knitting:

-   Kraj as fixed vs random effects
-   Transformation vs no transformation


```{r}

# Set all forms of outcome variable
dv <- c("dni_do_rekomendacji", "log_days")

# Set additional controlling fixed effects
control_pred <- c(
  "Therapeutic_lumped", 
  "Rekomendacja",
  "Drug_category"
  )

control_pred2 <- map(1:3, combn, x = control_pred, simplify = F) %>% 
  unlist(recursive = F) %>% 
  map(str_c, collapse = " + ") %>% 
  unlist()
  


# Set random effects
random_effects <- c("(1|ID)", "(1|Kraj)")

# Set all combinations of model formulas
model_formulas <- expand_grid(dv, control_pred2, random_effects) %>% 
  mutate(
    Country_fixed = if_else(random_effects == "(1|ID)", "Kraj", ""),
    mod_formula = pmap_chr(
      list(Country_fixed, control_pred2, random_effects), 
      paste, 
      sep = " + "
      ),
    mod_formula = str_replace(mod_formula, "^.\\+", ""),
    formula = map2_chr(dv, mod_formula, str_c, sep = " ~ "),
    mod_formula = map(formula, as.formula),
    transformation = if_else(dv == "dni_do_rekomendacji", "none", "logarithmic"),
    Country_fixed = if_else(Country_fixed == "Kraj", T, F)
    ) %>% 
  select(transformation, Country_fixed, formula, mod_formula)


# Choose model types based on the selected parameters
model_formulas2 <- model_formulas %>% 
  filter(transformation == params$transformation, Country_fixed == params$country_fixed)

```




# Data cleaning



```{r}

df %>% 
  count(ID, Agencja_kraj) %>% 
  filter(n != 1)



```


Dla agencji, które miały więcej niż jedną rekomendację w danym wskazaniu, wybieram tę krótszą / wcześniejszą


```{r}

df <- df %>% 
  group_by(ID, Agencja_kraj) %>% 
  arrange(dni_do_rekomendacji) %>% 
  slice(1) %>% 
  ungroup()


```



# Mixed-effects models 


## Full data analysis

```{r}

# Fit all variations of mixed-effects models
models_df <- model_formulas2 %>% 
  mutate(
    model = map(mod_formula, lmer, data = df),
    residuals = map(model, residuals),
    predicted = map(model, predict),
    AIC = map_dbl(model, function(x) {AIC(logLik(x))})
  )

models_df_unnested <-  models_df %>% 
  unnest(cols = c(residuals, predicted))  

models_df_unnested %>% 
  ggplot(aes(sample = residuals)) +
  geom_qq_line() +
  geom_qq() +
  facet_wrap(~formula, scales = "free")


```

Seems like the models fitted to data with a logarithmically transformed dv display a smaller deviation from the normal distribution, which could be further corrected with filtering individual extreme values.


```{r}

models_df_unnested %>% 
  ggplot(aes(predicted, residuals)) +
  geom_point() +
  facet_wrap(~formula, scales = "free") +
  geom_smooth(se = F)

```




```{r}
models_df %>% 
  arrange(AIC) %>% 
  select(formula, AIC) %>% 
  html_table()
  
```


```{r}

model_formulas2 %>% 
  html_table()


```



