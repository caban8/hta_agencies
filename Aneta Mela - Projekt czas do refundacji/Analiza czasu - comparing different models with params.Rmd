---
title: "Country comparison in terms of the time to recommendation"
output: 
  html_document:
    code_folding: show
    theme:
      bg: "#202123"
      fg: "#B8BCC2"
      primary: "#EA80FC"
      secondary: "#00DAC6"
      base_font:
        google: Prompt
      heading_font:
        google: Proza Libre
params:
  transformation: 
    label: "Transformation of the dependent variable"
    value: none
    input: select
    choices: [none, logarithmic]
  random_effects: 
    label: Variables as random effects
    value: "|ID"
    input: select
    choices: ["|ID", "|Year", "+ Year | ID"]
  maximum_days: 3000
  min_recommendations: 
    label: "Minimum number of recommendations per indication"
    value: 1
    input: slider
    step: 1
    min: 1
    max: 11
---

# Setup

```{r setup, include=FALSE}
if (requireNamespace("thematic")) 
  thematic::thematic_rmd(font = "auto")

knitr::opts_chunk$set(fig.width = 10, dpi = 300)


pacman::p_load(rstatix, readxl, tidyverse, broom, lme4, DT)

df <- read_excel("d:/SPSS and statistics/Work/Zlecenia/Aneta Mela/Baza filtr na dates 2024-03-04.xlsx") 

df <- df %>% 
  select(-c(...1, ...2))



# Ustalam levels dla countries tak, żeby Poland było kategorią referencyjną
Kraj_lvls <- c(
      "Poland",
      "Australia",
      "Canada",
      "England",
      "France",
      "Germany",
      "Ireland",
      "New Zealand",
      "Norway",
      "Scotland",
      "The Netherlands",
      "Wales"  
    )

# Ustalam poziomy factors - Poland first
df <- df %>% 
  mutate(Kraj = factor(Kraj, levels = Kraj_lvls))



# Lump categories few observations to "other" and add DV transformations 
df <- df %>% 
  mutate(
    Therapeutic_lumped = fct_lump(Obszar_terapeutyczny, n = 7),
    Therapeutic_lumped = fct_relevel(Therapeutic_lumped, "Other"),
    log_days = if_else(dni_do_rekomendacji == 0, 1, dni_do_rekomendacji) %>% log(),
    Drug_category = if_else(Kategoria_lek == "Orphan", "Orphan", "Other")
    ) 





```


** JAK WSZYSTKO ZAUTOMATYZOWAĆ ŻEBY SPRAWDZAĆ WSZYSTKIE WARIANTY MODELI ** 

# Uwagi

Celem logarytmizacji dni do rekomendacji, liczba dni, która wynosiła zero zostala przekształcona do 1 (to dało możliwość obliczenia logarytmu).


# Methodology

-   Ważna kwestia. Teoretycznie mamy tutaj do czynienia z jakąś formą within-design. W końcu agencja to pojedynczy byt, dla którego mamy więcej niż jeden powtórzony pomiar.

**Mixed effects model**

What exactly having different intercepts for the random effect variable means? How can I make a conceptual or theoretical connection here?


**Which variables can be inclued as fixed-effects?**

Is there a theoretical justification to include criteria of benefits, like clinical benefit or cost-effectiveness, in the model?

There is definitely a theoretical basis for including therapeutic area, as the processing of drugs from different areas might be guided by different goals which could be reflected in differences of their prioritization by specific medical and govermnetal insitutions.

Whether the recommendation was positive or negative might also play a role. It should be easier to find reasons to dismiss a drug than to accept it, as rejection is often a result of not meeting just one of many criteria, while acceptance is more often associated with meeting all of them. 


# Infrastruktura


## Functions

```{r}

# Import functions for performance measures
source("Funkcje/performance functions.R")

```


## Tables

```{r}

html_table <- function(x) {
  x %>% 
    knitr::kable()
}

```



## Params - Parameters

Parameters included in order to vary the models:

-   Country as a fixed vs random effects?
    -   Something to consider in theoretical terms
-   Transformation of the dependent variable (to correct deviations from the assumptions, if necessary)
    -   Logarithmic
    -   Other?
-   Minimum value of observations per indication 
    

Should I compare the AIC (or other similar measure) between lm and lmer models? To justify using the latter?

    

Params for iterated markdown knitting:

-   Kraj as fixed vs random effects
-   Transformation vs no transformation


```{r}

# Set all forms of outcome variable
dv <- c("dni_do_rekomendacji", "log_days")

# Set additional controlling fixed effects
control_pred <- c(
  "Kraj",
  "Rekomendacja",
  "Drug_category",
  "Therapeutic_lumped",
  "Therapeutic_lumped:Kraj"
  # "Therapeutic_lumped:Rekomendacja",
  # "Kraj:Rekomendacja"
  # "Obszar_terapeutyczny", 
  # "Obszar_terapeutyczny:Kraj"
  # "Kat1_Korzyść_kliniczna",
  # "Kat1_Efektywność_kosztowa"
  # "Kat2_Wpływ_budżet",
  # "Kat1_Bezpieczeństwo"
  # "Year",
  )

control_pred2 <- map(1:3, combn, x = control_pred, simplify = F) %>% 
  unlist(recursive = F) %>% 
  map(str_c, collapse = " + ") %>% 
  unlist() 
  




# Set random effects
random_effects <- str_c("(1", params$random_effects,  ")")




# Set all combinations of model formulas
model_formulas <- expand_grid(dv, control_pred2, random_effects) %>% 
  mutate(
    mod_formula = pmap_chr(
      list(control_pred2, random_effects), 
      paste, 
      sep = " + "
      ),
    mod_formula = str_replace(mod_formula, "^.\\+", ""),
    formula = map2_chr(dv, mod_formula, str_c, sep = " ~ "),
    mod_formula = map(formula, as.formula),
    transformation = if_else(dv == "dni_do_rekomendacji", "none", "logarithmic")
    ) %>% 
  select(transformation, formula, mod_formula)




# Choose model types based on the selected parameters
model_formulas2 <- model_formulas %>% 
  filter(
    transformation == params$transformation
    )

```




# Data cleaning



```{r}


repeated_recommendations <- df %>% 
  count(ID, Agencja_kraj) %>% 
  filter(n != 1) %>% 
  nrow()



```

There were `r repeated_recommendations` instances of recommendations that were processed more than once for a given indication by a given country. 

From each such group of repeated recommendations only the one associaited with the smallest number of days is selected.




```{r}

# Select only one recommendation per country per indication
df <- df %>% 
  group_by(ID, Agencja_kraj) %>% 
  arrange(dni_do_rekomendacji) %>% 
  slice(1) %>% 
  ungroup()


# Remove missing data
df <- df %>% 
  drop_na(dni_do_rekomendacji, Therapeutic_lumped, Rekomendacja, ID)


# Add information about number of recommendations per indicaiton
df <- df %>% 
  group_by(ID) %>% 
  mutate(ID_recommendations = n()) %>% 
  ungroup() 


```


## Filtering options

```{r}

# 
df <- df %>%
  filter(
    dni_do_rekomendacji < params$maximum_days, # Observations below a given number of days
    ID_recommendations >= params$min_recommendations
    )


```



# Mixed-effects models 



```{r}
# Fit all variations of mixed-effects models
models_df <- model_formulas2 %>% 
  mutate(
    model = map(mod_formula, lmer, data = df),
    residuals = map(model, residuals),
    predicted = map(model, predict),
    AIC = map_dbl(model, function(x) {AIC(logLik(x))}),
    r2_marg = map_dbl(model, r2_marginal),
    r2_cond = map_dbl(model, r2_conditional)
  ) %>% 
  arrange(desc(r2_marg))

models_df_unnested <-  models_df %>% 
  unnest(cols = c(residuals, predicted)) %>% 
  mutate(formula = fct_reorder(formula, desc(r2_marg)))
```


## Normality assumption


```{r}
models_df_unnested %>% 
  ggplot(aes(sample = residuals)) +
  geom_qq_line() +
  geom_qq() +
  facet_wrap(~formula, scales = "free")


```


## Homoscedasticity assumption


```{r fig.height=20}

models_df_unnested %>% 
  ggplot(aes(predicted, residuals)) +
  geom_point() +
  facet_wrap(~formula, scales = "free", ncol = 3) +
  geom_smooth(se = F)

```


## Comparison of performance measures


```{r}
models_df %>% 
  select(formula, AIC, r2_marg, r2_cond) %>% 
  datatable()
  
```


## Models


```{r}

model_formulas2 %>% 
  html_table() %>% 
  datatable()


```



# Weigthed mixed-effects models





